<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:ObjectName="ComplexETLPackage"
  DTS:Description="A complex SSIS package with multiple transform types"
  DTS:CreationDate="2024-03-10T14:00:00"
  DTS:CreatorName="TestUser"
  DTS:FormatVersion="8"
  DTS:DTSID="{AAA00000-0000-0000-0000-000000000002}">

  <!-- Connection Managers -->
  <DTS:ConnectionManager
    DTS:ObjectName="SourceDB"
    DTS:DTSID="{BBB00000-0000-0000-0000-000000000010}"
    DTS:CreationName="OLEDB">
    <DTS:ObjectData>
      <DTS:ConnectionManager
        ConnectionString="Data Source=src-server;Initial Catalog=SalesDB;Provider=SQLNCLI11.1;" />
    </DTS:ObjectData>
  </DTS:ConnectionManager>

  <DTS:ConnectionManager
    DTS:ObjectName="DestWarehouse"
    DTS:DTSID="{BBB00000-0000-0000-0000-000000000011}"
    DTS:CreationName="OLEDB">
    <DTS:ObjectData>
      <DTS:ConnectionManager
        ConnectionString="Data Source=dw-server;Initial Catalog=DataWarehouse;Provider=SQLNCLI11.1;" />
    </DTS:ObjectData>
  </DTS:ConnectionManager>

  <DTS:ConnectionManager
    DTS:ObjectName="FlatFileExport"
    DTS:DTSID="{BBB00000-0000-0000-0000-000000000012}"
    DTS:CreationName="FLATFILE">
    <DTS:ObjectData>
      <DTS:ConnectionManager ConnectionString="C:\Export\sales_export.csv" />
    </DTS:ObjectData>
  </DTS:ConnectionManager>

  <!-- Variables -->
  <DTS:Variable DTS:ObjectName="StartDate" DTS:Namespace="User">
    <DTS:VariableValue DTS:DataType="String">2024-01-01</DTS:VariableValue>
  </DTS:Variable>

  <!-- Parameters -->
  <DTS:PackageParameter DTS:ObjectName="Environment" DTS:DataType="String">
    <DTS:Property DTS:Name="ParameterValue">Production</DTS:Property>
  </DTS:PackageParameter>

  <!-- Control Flow -->
  <DTS:Executables>

    <!-- Sequence Container: Initialize -->
    <DTS:Executable
      DTS:ObjectName="Initialize"
      DTS:DTSID="{CCC00000-0000-0000-0000-000000000010}"
      DTS:CreationName="STOCK:SEQUENCE"
      DTS:Description="Initialization tasks">
      <DTS:Executables>
        <DTS:Executable
          DTS:ObjectName="Set Audit Start"
          DTS:DTSID="{CCC00000-0000-0000-0000-000000000011}"
          DTS:CreationName="Microsoft.ExecuteSQLTask">
          <DTS:ObjectData>
            <SQLTask:SqlTaskData
              xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask"
              SQLTask:SqlStatementSource="INSERT INTO AuditLog(PackageName, StartTime) VALUES('ComplexETL', GETDATE())" />
          </DTS:ObjectData>
        </DTS:Executable>
      </DTS:Executables>
    </DTS:Executable>

    <!-- Data Flow with Lookup and Conditional Split -->
    <DTS:Executable
      DTS:ObjectName="Transform Sales Data"
      DTS:DTSID="{CCC00000-0000-0000-0000-000000000012}"
      DTS:CreationName="Microsoft.Pipeline"
      DTS:Description="Complex sales data transformation with lookup and split">
      <DTS:ObjectData>
        <pipeline version="1">
          <components>
            <component name="Sales Source" componentClassID="Microsoft.OLEDBSource">
              <properties>
                <property name="SqlCommand">SELECT OrderID, CustomerID, ProductID, Quantity, UnitPrice, OrderDate FROM dbo.Orders</property>
              </properties>
            </component>

            <component name="Product Lookup" componentClassID="Microsoft.Lookup">
              <properties>
                <property name="SqlCommand">SELECT ProductID, ProductName, Category FROM dbo.Products</property>
              </properties>
            </component>

            <component name="Calculate Total" componentClassID="Microsoft.DerivedColumn">
              <outputs>
                <output name="Derived Column Output">
                  <outputColumns>
                    <outputColumn name="TotalAmount" dataType="numeric" />
                  </outputColumns>
                </output>
              </outputs>
            </component>

            <component name="Split by Category" componentClassID="Microsoft.ConditionalSplit">
            </component>

            <component name="Aggregate by Customer" componentClassID="Microsoft.Aggregate">
            </component>

            <component name="Script - Custom Logic" componentClassID="Microsoft.ScriptComponent">
              <properties>
                <property name="ScriptLanguage">CSharp</property>
              </properties>
            </component>

            <component name="Warehouse Destination" componentClassID="Microsoft.OLEDBDestination">
              <properties>
                <property name="OpenRowset">dbo.Fact_Sales</property>
              </properties>
            </component>
          </components>
        </pipeline>
      </DTS:ObjectData>
    </DTS:Executable>

    <!-- ForEach Loop: Process Regions -->
    <DTS:Executable
      DTS:ObjectName="Process Each Region"
      DTS:DTSID="{CCC00000-0000-0000-0000-000000000013}"
      DTS:CreationName="STOCK:FOREACHLOOP"
      DTS:Description="Process data for each region">
      <DTS:Executables>
        <DTS:Executable
          DTS:ObjectName="Load Region Data"
          DTS:DTSID="{CCC00000-0000-0000-0000-000000000014}"
          DTS:CreationName="Microsoft.ExecuteSQLTask">
          <DTS:ObjectData>
            <SQLTask:SqlTaskData
              xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask"
              SQLTask:SqlStatementSource="EXEC dbo.sp_LoadRegionData @RegionID = ?" />
          </DTS:ObjectData>
        </DTS:Executable>
      </DTS:Executables>
    </DTS:Executable>

    <!-- Script Task -->
    <DTS:Executable
      DTS:ObjectName="Send Notification"
      DTS:DTSID="{CCC00000-0000-0000-0000-000000000015}"
      DTS:CreationName="Microsoft.ScriptTask"
      DTS:Description="Send email notification on completion">
    </DTS:Executable>

  </DTS:Executables>

  <!-- Event Handlers -->
  <DTS:EventHandlers>
    <DTS:EventHandler DTS:EventName="OnError">
      <DTS:Executables>
        <DTS:Executable
          DTS:ObjectName="Log Error"
          DTS:DTSID="{CCC00000-0000-0000-0000-000000000020}"
          DTS:CreationName="Microsoft.ExecuteSQLTask">
          <DTS:ObjectData>
            <SQLTask:SqlTaskData
              xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask"
              SQLTask:SqlStatementSource="INSERT INTO ErrorLog(ErrorMessage, ErrorTime) VALUES(?, GETDATE())" />
          </DTS:ObjectData>
        </DTS:Executable>
      </DTS:Executables>
    </DTS:EventHandler>
  </DTS:EventHandlers>

</DTS:Executable>
